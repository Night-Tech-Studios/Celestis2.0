<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestis AI Avatar</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>Celestis AI Avatar</h1>
            <div class="header-controls">
                <button id="clearChatBtn" class="btn btn-secondary">Clear Chat</button>
                <button id="settingsBtn" class="btn btn-secondary">Settings</button>
                <button id="openPreviewBtn" class="btn btn-secondary">Open Preview</button>
                <button id="import2dBtn" class="btn btn-secondary">Import 2D Avatar</button>
                <button id="importVrmBtn" class="btn btn-primary">Import 3D Model</button>
                <select id="internalAvatarSelect" class="btn btn-secondary" title="Internal Avatars">
                    <option value="">Internal Avatars...</option>
                </select>
            </div>
        </header>

        <!-- Background Avatar Canvas (now placed inside chat area for centered model) -->
        <!-- canvas moved into the chat container further below -->
        <!-- Foreground Avatar Overlay (2D image) -->
        <div id="avatarOverlay" class="avatar-overlay" aria-hidden="true">
            <img id="avatarOverlayImg" alt="Avatar" src="" />
            <div class="avatar-shadow"></div>
        </div>
        
        <!-- Avatar Status -->
        <div id="avatarStatus" class="status-indicator">Initializing...</div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Chat Interface -->
                <div class="chat-container">
                    <!-- Avatar canvas placed inside chat so the model appears centered within chat area -->
                    <canvas id="avatarCanvas"></canvas>
                <div id="chatMessages" class="chat-messages"></div>
                
                <div class="input-container">
                    <div class="input-controls">
                        <button id="micBtn" class="btn btn-voice" title="Voice Input">
                            <span class="mic-icon">ðŸŽ¤</span>
                        </button>
                        <input type="text" id="textInput" placeholder="Type your message..." class="text-input">
                        <button id="sendBtn" class="btn btn-send">Send</button>
                    </div>
                    <div id="voiceStatus" class="voice-status"></div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="close-btn" id="closeSettingsBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="setting-group">
                        <label for="openrouterApiKey">OpenRouter API Key:</label>
                        <input type="password" id="openrouterApiKey" placeholder="Enter your OpenRouter API key">
                    </div>
                    <div class="setting-group">
                        <label for="aiModel">AI Model:</label>
                        <select id="aiModel">
                            <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                            <option value="anthropic/claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="openai/gpt-4">GPT-4</option>
                            <option value="openai/gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="meta-llama/llama-2-70b-chat">Llama 2 70B</option>
                            <option value="meta-llama/llama-4-maverick:free">Llama 4 Maverick (Free)</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="username">Your name (for AI):</label>
                        <input type="text" id="username" placeholder="Enter your preferred display name" />
                        <small class="setting-help">Optional. The AI will use this name when addressing you in chat.</small>
                    </div>
                    <div class="setting-group">
                        <label for="rendererEngine">Renderer Engine:</label>
                        <select id="rendererEngine">
                            <option value="2d">2D Canvas (Default)</option>
                        </select>
                        <small class="setting-help">Select the renderer engine. The 3D renderer can use Babylon.js or Three.js; GLTF/GLB models are supported where loader plugins are available.</small>
                    </div>
                    <div class="setting-group">
                        <label for="avatarScroll">Avatar Scrolling</label>
                        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                            <input type="checkbox" id="avatarScroll" />
                            <small class="setting-help" style="margin:0">Enable subtle avatar movement when the window or chat scrolls (parallax)</small>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label for="avatarInChat">Avatar in Chat</label>
                        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                            <input type="checkbox" id="avatarInChat" />
                            <small class="setting-help" style="margin:0">Place avatar inside the chat area and auto-resize to the chat box</small>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label for="voiceLanguage">Voice Recognition Language:</label>
                        <select id="voiceLanguage">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="pt-BR">PortuguÃªs (Brasil)</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                            <option value="ja-JP">Japanese</option>
                        </select>
                    </div>
                    <div class="setting-group">
                        <label for="micSelect">Microphone:</label>
                        <select id="micSelect">
                            <option value="">(Default system microphone)</option>
                        </select>
                        <small class="setting-help">Choose the input device for voice recording. Your browser/OS must grant microphone permission.</small>
                    </div>
                    <div class="setting-group">
                        <label for="ttsEnabled">Text-to-Speech (TTS)</label>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-top:6px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="ttsEnabled" />
                                <small class="setting-help" style="margin:0">Enable TTS for AI responses</small>
                            </div>
                            <div style="display:flex; align-items:center; gap:8px;">
                                <label for="ttsVoice" style="min-width:110px;">Voice:</label>
                                <select id="ttsVoice" style="flex:1">
                                    <option value="">(Default browser voice)</option>
                                </select>
                            </div>
                            <small class="setting-help">TTS is performed by the browser using available system voices. If no voice appears, try restarting the app or your OS.</small>
                        </div>
                    </div>
                    <div class="setting-group">
                        <label for="initialTemplate">AI Initial Template:</label>
                        <div id="templatePresets" class="template-presets">
                            <small>Quick presets:</small>
                            <button type="button" class="preset-btn" data-preset="Celestis">Celestis</button>
                            <button type="button" class="preset-btn" data-preset="Frieren">Frieren</button>
                            <button type="button" class="preset-btn" data-preset="Tsuyu_Asui">Tsuyu_Asui</button>
                            <button type="button" class="preset-btn" data-preset="Void_Nexai">Void_Nexai</button>
                        </div>
                        <textarea id="initialTemplate" placeholder="Example: You are a knowledgeable AI assistant with expertise in technology. Respond in a friendly but professional manner. Keep answers concise and helpful." rows="4"></textarea>
                        <small class="setting-help">This template sets the AI's base personality and behavior. It won't appear in chat messages but will guide all AI responses. Changes take effect immediately.</small>
                    </div>
                    <div class="setting-group">
                        <label for="rememberConversation">Remember conversation (debug)</label>
                        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
                            <input type="checkbox" id="rememberConversation" />
                            <small class="setting-help" style="margin:0">When enabled, the app will persist recent chat history across runs (useful for debugging). Saved messages are limited for privacy.</small>
                        </div>
                        <div style="margin-top:8px;">
                            <button type="button" id="clearRememberedConversationBtn" class="btn btn-secondary">Clear remembered conversation</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Three.js r160 and VRM libraries -->
    <script>
        console.log('[INIT] Loading Three.js and VRM libraries...');
    </script>
    <script>
        // If running inside Electron with nodeIntegration, prefer local node_modules copy first
        (async function(){
            try {
                if (typeof process !== 'undefined' && process.versions && process.versions.electron && typeof require === 'function') {
                    console.log('[INIT] Detected Electron renderer, attempting to require local three and loaders');
                    try {
                        // Prefer requiring by module name so resolution uses node's resolver
                        let three;
                        try {
                            three = require('three');
                        } catch (e) {
                            // fallback to relative
                            three = require('../node_modules/three/build/three.js');
                        }

                        if (three) {
                            // some versions export as module default or as the namespace
                            window.THREE = (three && three.default) ? three.default : three;
                            console.log('[INIT] âœ“ Loaded local three from node_modules');
                        }

                        // Attempt to require the UMD GLTFLoader (may attach to window.THREE)
                        try {
                            require('three/examples/js/loaders/GLTFLoader.js');
                            console.log('[INIT] âœ“ Required UMD GLTFLoader');
                        } catch (e) {
                            console.warn('[INIT] UMD GLTFLoader require failed:', e && e.message);
                        }

                        // If GLTFLoader still not present, try dynamic ESM import of the jsm loader
                        if (!window.THREE || !window.THREE.GLTFLoader) {
                            try {
                                // Use an explicit file URL for the examples jsm loader so browser-like renderer resolves correctly
                                const gltfJsmUrl = new URL('../node_modules/three/examples/jsm/loaders/GLTFLoader.js', window.location.href).href;
                                const mod = await import(gltfJsmUrl);
                                const GLTFLoader = mod.GLTFLoader || mod.default || mod;
                                if (GLTFLoader) {
                                    // Attach constructor to global THREE so existing code can use it
                                    try { window.THREE = window.THREE || (require('three')?.default || require('three')); } catch(_) {}
                                    window.THREE.GLTFLoader = GLTFLoader;
                                    console.log('[INIT] âœ“ Imported jsm GLTFLoader and attached to window.THREE');
                                }
                            } catch (e) {
                                console.warn('[INIT] Dynamic import of jsm GLTFLoader failed:', e && e.message);
                            }
                        }

                        // Try to require or import Pixiv three-vrm
                        try {
                            const vrmPkg = require('@pixiv/three-vrm');
                            window.THREE_VRM = vrmPkg && (vrmPkg.default || vrmPkg);
                            console.log('[INIT] âœ“ Required @pixiv/three-vrm');
                        } catch (e) {
                            // Attempt dynamic import via promise (no top-level await in non-module script)
                            try {
                                import('@pixiv/three-vrm').then((vrmMod) => {
                                    try { window.THREE_VRM = vrmMod && (vrmMod.default || vrmMod); } catch(_){}
                                    console.log('[INIT] âœ“ Imported @pixiv/three-vrm');
                                }).catch((ie) => {
                                    console.warn('[INIT] pixiv three-vrm not available locally');
                                });
                            } catch (ie) {
                                console.warn('[INIT] pixiv three-vrm not available locally');
                            }
                        }
                    } catch (e) {
                        console.warn('[INIT] Failed to bootstrap local three/loaders:', e && e.message);
                    }
                }
            } catch (_e) {
                // ignore
            }
        })();
    </script>
    <!-- Three.js and three-vrm are provided by preload in Electron; CDN removed to avoid duplicate instances -->
    <script>
        console.log('[INIT] Checking THREE and VRM...');

        // Global error handlers to capture runtime failures and forward to main for diagnostics
        try {
            window.addEventListener('error', (ev) => {
                try {
                    console.error('[GLOBAL ERROR]', ev.error || ev.message || ev);
                    if (window && window.electronAPI && window.electronAPI.send) {
                        window.electronAPI.send('debug-log', '[GLOBAL ERROR] ' + (ev.error && ev.error.stack ? ev.error.stack : (ev.message || String(ev))));
                    }
                } catch(_){}
            });

            window.addEventListener('unhandledrejection', (ev) => {
                try {
                    console.error('[UNHANDLED REJECTION]', ev.reason || ev);
                    if (window && window.electronAPI && window.electronAPI.send) {
                        window.electronAPI.send('debug-log', '[UNHANDLED REJECTION] ' + (ev.reason && ev.reason.stack ? ev.reason.stack : String(ev.reason || ev)));
                    }
                } catch(_){}
            });
        } catch (e) { /* ignore */ }

        // If preload exposed modules via `window.celestis`, use them immediately
        try {
            if (window.celestis && window.celestis.three) {
                console.log('[INIT] Detected preload-provided three via window.celestis');
                try { window.THREE = window.celestis.three; } catch(_){}
                try { if (window.celestis.threeVrm) window.THREE_VRM = window.celestis.threeVrm; } catch(_){}
                window.__threeModulesLoaded = true;
                window.__preloadAttachTime = window.celestis.preloadAttachTime || Date.now();
                window.dispatchEvent(new CustomEvent('threejs-ready'));
            }
        } catch (e) { /* ignore */ }

        // If preload exposed UMD source strings, inject them directly (works well for packaged builds)
        try {
            if ((!window.THREE || !window.THREE.GLTFLoader) && window.celestis && (window.celestis.__threeUmd || window.celestis.__gltfUmd)) {
                try {
                    if (window.celestis.__threeUmd) {
                        const s = document.createElement('script');
                        s.type = 'text/javascript';
                        s.text = window.celestis.__threeUmd;
                        document.head.appendChild(s);
                        console.log('[INIT] Injected preload-provided UMD three');
                    }
                    if (window.celestis.__gltfUmd) {
                        const s2 = document.createElement('script');
                        s2.type = 'text/javascript';
                        s2.text = window.celestis.__gltfUmd;
                        document.head.appendChild(s2);
                        console.log('[INIT] Injected preload-provided UMD GLTFLoader');
                    }
                } catch (e) { console.warn('[INIT] Preload UMD injection failed:', e && e.message); }
            }
        } catch (e) { /* ignore */ }

        function handleThreeReady() {
            if (typeof THREE === 'undefined') {
                console.error('[INIT] âœ— THREE not available');
                return;
            }
            console.log('[INIT] âœ“ THREE loaded, revision:', THREE.REVISION);
            console.log('[INIT] âœ“ THREE-VRM loaded:', !!window.THREE_VRM);

            // Create a VRMLoader wrapper that prefers Pixiv's three-vrm APIs (UMD) and falls back to GLTFLoader
            if (window.THREE_VRM) {
                THREE.VRMLoader = class VRMLoader {
                    constructor() {
                        this.gltfLoader = (typeof THREE.GLTFLoader !== 'undefined') ? new THREE.GLTFLoader() : null;
                    }

                    async _convertToVRM(gltf) {
                        if (window.THREE_VRM && window.THREE_VRM.VRM) {
                            try {
                                return await window.THREE_VRM.VRM.from(gltf);
                            } catch (e) {
                                console.warn('THREE_VRM.VRM.from failed, returning raw gltf scene:', e);
                                return { scene: gltf.scene, animations: gltf.animations || [], humanoid: null };
                            }
                        }
                        return { scene: gltf.scene, animations: gltf.animations || [], humanoid: null };
                    }

                    load(url, onLoad, onProgress, onError) {
                        if (!this.gltfLoader) {
                            if (onError) onError(new Error('No GLTFLoader available to load VRM'));
                            return;
                        }

                        this.gltfLoader.load(url, async (gltf) => {
                            try {
                                const vrm = await this._convertToVRM(gltf);
                                if (onLoad) onLoad(vrm);
                            } catch (e) {
                                console.error('VRM creation error:', e);
                                if (onError) onError(e);
                            }
                        }, onProgress, onError);
                    }

                    parse(data, onLoad, onError) {
                        if (!this.gltfLoader) {
                            if (onError) onError(new Error('No GLTFLoader available to parse VRM data'));
                            return;
                        }

                        this.gltfLoader.parse(data, '', async (gltf) => {
                            try {
                                const vrm = await this._convertToVRM(gltf);
                                if (onLoad) onLoad(vrm);
                            } catch (e) {
                                console.error('VRM parse error:', e);
                                if (onError) onError(e);
                            }
                        }, onError);
                    }
                };
                console.log('[INIT] âœ“ VRMLoader (pixiv) wrapper created');
            }

            window.__threeModulesLoaded = true;
            window.dispatchEvent(new CustomEvent('threejs-ready'));
        }

        // Electron detection: prefer preload marker and platform exposed by preload; fall back to userAgent only if those are missing
        const platformMarker = (typeof window !== 'undefined' && window.__platform) ? window.__platform : null;
        const uaHasElectron = (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.indexOf('Electron') !== -1);
        const detectedElectron = !!window.__isElectron || (platformMarker !== null) || uaHasElectron;
        console.log('[INIT] Detection -> __isElectron:', !!window.__isElectron, 'platformMarker:', platformMarker, 'userAgentElectron:', uaHasElectron, 'preloadAttachTime:', window.__preloadAttachTime || 'none');

        if (detectedElectron) {
            console.log('[INIT] Running inside Electron (detected), waiting for preload to attach modules');
            // If preload already attached modules, handle immediately
            if (window.__threeModulesLoaded) {
                console.log('[INIT] Preload already attached modules (early), calling handleThreeReady now, preloadAttachTime=' + (window.__preloadAttachTime || 'na'));
                handleThreeReady();
            } else {
                // Show a gentle timeout log if preload doesn't arrive quickly
                const timeoutMs = 5000;
                let didHandle = false;
                const onReady = () => { didHandle = true; handleThreeReady(); };
                window.addEventListener('threejs-ready', onReady, { once: true });

                setTimeout(() => {
                    if (!didHandle) {
                        console.warn('[INIT] threejs-ready did not arrive within ' + timeoutMs + 'ms; continuing to wait but not treating this as a CDN failure yet');
                    }
                }, timeoutMs);
            }
        } else {
            if (typeof THREE !== 'undefined') {
                handleThreeReady();
            } else {
                        console.error('[INIT] \u2717 THREE failed to load from CDN');
                        // As a fallback, try to require three from node_modules (Electron renderer may allow require)
                        (async function tryRequireThree(){
                            try {
                                if (typeof require === 'function') {
                                    console.log('[INIT] Attempting to require("three") as fallback');
                                    const threePkg = require('three');
                                    window.THREE = (threePkg && threePkg.default) ? threePkg.default : threePkg;
                                    console.log('[INIT] âœ“ Loaded three via require fallback');
                                    handleThreeReady();
                                }
                            } catch (err) {
                                console.warn('[INIT] require("three") fallback failed:', err && err.message);
                                // If require failed or not available, ask main for UMD sources and inject them
                                try {
                                    if (window && window.electronAPI && window.electronAPI.invoke) {
                                        console.log('[INIT] Requesting UMD three sources from main process');
                                        const res = await window.electronAPI.invoke('get-three-umd');
                                        if (res && (res.three || res.gltfLoader)) {
                                            if (res.three) {
                                                const s = document.createElement('script');
                                                s.type = 'text/javascript';
                                                s.text = res.three;
                                                document.head.appendChild(s);
                                                console.log('[INIT] Injected UMD three from main');
                                            }
                                            if (res.gltfLoader) {
                                                const s2 = document.createElement('script');
                                                s2.type = 'text/javascript';
                                                s2.text = res.gltfLoader;
                                                document.head.appendChild(s2);
                                                console.log('[INIT] Injected UMD GLTFLoader from main');
                                            }
                                            // Allow a brief moment for globals to attach
                                            setTimeout(() => {
                                                if (typeof THREE !== 'undefined') {
                                                    handleThreeReady();
                                                } else {
                                                    console.warn('[INIT] Injected UMD did not attach THREE');
                                                }
                                            }, 50);
                                        }
                                    }
                                } catch (_e) { console.warn('[INIT] UMD injection attempt failed: ' + (_e && _e.message)); }
                            }
                        })();
            }
        }
    </script>
    <!-- ESM renderer helper that configures GLTFLoader with Pixiv VRM plugins -->
    <script type="module" src="renderer/vrmSetup.js"></script>
    <!-- Ensure a local module-based THREE attachment is available as an early fallback -->
    <script type="module" src="three-modules.js"></script>

    <!-- Babylon.js: prefer preload-provided node_modules instance; fall back to CDN UMD if not present -->
    <script>
        (function(){
            try {
                if (window.celestis && window.celestis.babylon) {
                    console.log('[INIT] Babylon provided by preload (node_modules)');
                    try { window.BABYLON = window.celestis.babylon; } catch(_){}
                } else {
                    console.log('[INIT] Loading Babylon CDN UMD');
                    const s = document.createElement('script');
                    s.src = 'https://cdn.babylonjs.com/babylon.js';
                    s.onload = () => { console.log('[INIT] Babylon CDN loaded'); };
                    s.onerror = () => { console.warn('[INIT] Babylon CDN failed to load'); };
                    document.head.appendChild(s);
                }
            } catch (e) { console.warn('[INIT] Babylon injection check failed: ' + (e && e.message)); }
        })();
    </script>

    <script src="modules/vrmLoader.js"></script>
    <script src="app.js"></script>
</body>
</html>